====================
Automatic form setup
====================

This package provides tools to construct z3c.form forms out of hints stored
in tagged values on schema interfaces. A special form base class is used to
set up the 'fields' and 'groups' properties on form instances.

The tagged values are stored under a key represented by the following 
constant:

    >>> from plone.autoform.interfaces import FORMDATA_KEY

In addition, field groups are constructed from plone.supermodel fieldsets,
which are also stored in tagged values, under the following constant:

    >>> from plone.supermodel.interfaces import FIELDSETS_KEY

There are several ways to set the form data:

    - Manually, by using setTaggedValue() on an interface.

    - By loading the schema from a plone.supermodel XML file. This package
      provides a schema handler for the 'form' prefix that can be used to
      incorporate form hints. See supermodel.txt for details.
      
    - By using the grok directives in the plone.directives.form package.
    
For the purposes of this test, we'll set the form data manually.

Test setup
----------

First, let's load this package's ZCML so that we can run the tests:

    >>> configuration = """\
    ... <configure xmlns="http://namespaces.zope.org/zope">
    ...
    ...     <include package="Products.Five" file="configure.zcml" />
    ...     <include package="plone.autoform" />
    ...     
    ... </configure>
    ... """
    >>> from StringIO import StringIO
    >>> from zope.configuration import xmlconfig
    >>> xmlconfig.xmlconfig(StringIO(configuration))

We also need a few sample interfaces:

    >>> from zope.interface import Interface
    >>> from zope import schema

    >>> class ITestSchema(Interface):
    ...     one = schema.TextLine(title=u"One")
    ...     two = schema.TextLine(title=u"Two")
    ...     three = schema.TextLine(title=u"Three")
    ...     four = schema.TextLine(title=u"Four")
    ...     five = schema.TextLine(title=u"Five")

    >>> class ISupplementarySchema(Interface):
    ...     one = schema.TextLine(title=u"One")
    ...     two = schema.TextLine(title=u"Two")

    >>> class IOtherSchema(Interface):
    ...     three = schema.TextLine(title=u"Three")
    ...     four = schema.TextLine(title=u"Four")
    ...     five = schema.TextLine(title=u"Five")

And a test context and request, marked with the IFormLayer interface to make
z3c.form happy:

    >>> from zope.publisher.browser import TestRequest
    >>> context = object()
    >>> request = TestRequest()

    >>> from z3c.form.interfaces import IFormLayer
    >>> from zope.interface import alsoProvides
    >>> alsoProvides(request, IFormLayer)

And finally, a form:

    >>> from plone.autoform.formbase import AutoExtensibleForm
    >>> from z3c.form import form, button
    >>> class TestForm(AutoExtensibleForm, form.Form):
    ...     schema = ITestSchema
    ...     additional_schemata = (ISupplementarySchema, IOtherSchema,)
    ...     
    ...     ignoreContext = True


Adding form data
----------------

The form data is a simple dict. We'll keep track of that in a variable so
that we can modify it for the tests later, and then set it onto the
interface as a tagged value.

    >>> test_form_data = {}
    >>> test_fieldsets = []
    >>> ITestSchema.setTaggedValue(FORMDATA_KEY, test_form_data)
    >>> ITestSchema.setTaggedValue(FIELDSETS_KEY, test_fieldsets)

    >>> supplementary_form_data = {}
    >>> supplementary_fieldsets = []
    >>> ISupplementarySchema.setTaggedValue(FORMDATA_KEY, supplementary_form_data)
    >>> ISupplementarySchema.setTaggedValue(FIELDSETS_KEY, supplementary_fieldsets)

    >>> other_form_data = {}
    >>> other_fieldsets = []
    >>> IOtherSchema.setTaggedValue(FORMDATA_KEY, other_form_data)
    >>> IOtherSchema.setTaggedValue(FIELDSETS_KEY, other_fieldsets)

The form data dict can contain the following keys.

    'omitted' -- A list of (field_name, boolean) pairs. If the second value
        evaluates to true, the given field name is omitted.
    
    'modes' -- A list of (field_name, mode) string pairs specifying z3c.form
        widget modes, including 'hidden', 'input' and 'display'.
    
    'widgets' -- A list of (field_name, widget) pairs. The widget can be
        the dotted name of a z3c.form field widget factory, or an actual
        instance of one.
        
    'before' -- A list of (field_name, before_name) pairs. before_name can
        be '*' (any/all fields), or the name of a field to move the given
        field before in the form.

    'after' -- A list of (field_name, after_name) pairs. after_name can
        be '*' (any/all fields), or the name of a field to move the given
        field after in the form.        
        
Field names should not contain a prefix. The default form schema interface
will not have a prefix, and additional schemata (see below) will have a
prefix constructed from their __identifier__ (full dotted name). The 
exceptions are 'before_name' and 'after_name', which must include
the relevant prefix.

Fieldset data is kept under the key defined in the constant FIELDSETS_KEY.
This contains a list of plone.supermodel.model.Fieldset instances.

At this point, the form data is empty. When the form is updated, the 'fields'
and 'groups' properties will be set.

    >>> test_form = TestForm(context, request)
    >>> test_form.update()
    >>> test_form.fields.keys() #doctest: +NORMALIZE_WHITESPACE
    ['one', 'two', 'three', 'four', 'five',
     '__builtin__.ISupplementarySchema.one', '__builtin__.ISupplementarySchema.two',
     '__builtin__.IOtherSchema.three', '__builtin__.IOtherSchema.four', '__builtin__.IOtherSchema.five']
    >>> test_form.groups
    ()

Note how we have all the fields from all the schemata, and that the fields
from the additional schemata have been prefixed with the schema dotted name.

Let us now set up some form data.

Omitted fields are listed like this:

    >>> test_form_data['omitted'] = [('four', True), ('five', True,)]

Field modes can be set like this:

    >>> test_form_data['modes'] = [('one', 'hidden'), ('two', 'display',)]

Widgets can be specified either by a dotted name string or an actual instance:

    >>> from z3c.form.browser.password import PasswordFieldWidget
    >>> test_form_data['widgets'] = [('two', PasswordFieldWidget)]
    >>> other_form_data['widgets'] = [('five', 'z3c.form.browser.password.PasswordFieldWidget')]

Fields can be moved like this:

    >>> test_form_data['after'] = [('one', 'two')]
    >>> supplementary_form_data['before'] = [('one', '*'), ('two', 'one')]
    >>> other_form_data['before'] = [('four', '__builtin__.ISupplementarySchema.one')]

Note how the second value of each tuple refers to the full name with a prefix,
so the field 'two' from ISupplementarySchema is moved before the field 'one'
from the default (un-prefixed) ITestSchema.

Finally, fieldsets are configured like this:

    >>> from plone.supermodel.model import Fieldset
    >>> test_fieldsets.append(Fieldset('fieldset1', fields=['three'],
    ...     label=u"Fieldset one", description=u"Description of fieldset one", ))
    >>> other_fieldsets.append(Fieldset('fieldset1', fields=['three']))

Note how the label/description need only be specified once.

The results of all of this can be seen below:

    >>> test_form = TestForm(context, request)
    >>> test_form.update()
    >>> test_form.fields.keys() #doctest: +NORMALIZE_WHITESPACE
    ['__builtin__.IOtherSchema.four',
     '__builtin__.ISupplementarySchema.one',
     'two',
     '__builtin__.ISupplementarySchema.two',
     'one',
     '__builtin__.IOtherSchema.five']

The field ISupplementarySchema['one'] was moved to the top of the form, but
then IOtherSchema['four'] was moved before this one again. ITestSchema['one']
was moved after ITestSchema['two']. ISupplementarySchema['two'] was then
moved before ITestSchema['one'], coming between ITestSchema['one'] and
ITestSchema['two'].

ITestSchema['one'] was hidden and ITestSchema['two'] was put into display
mode:

    >>> test_form.widgets['one'].mode
    'hidden'
    >>> test_form.widgets['two'].mode
    'display'

ITestSchema['two'] and IOtherSchema['five'] were both given a password
widget - one by instance, the other by dotted name:

    >>> test_form.widgets['two']
    <PasswordWidget 'form.widgets.two'>

    >>> test_form.widgets['__builtin__.IOtherSchema.five']
    <PasswordWidget 'form.widgets.__builtin__.IOtherSchema.five'>

There is one group corresponding to the fieldset where we put two fields. It
has taken the label and description from the first definition.

    >>> len(test_form.groups)
    1
    >>> test_form.groups[0].label
    u'Fieldset one'
    >>> test_form.groups[0].description
    u'Description of fieldset one'
    >>> test_form.groups[0].fields.keys() #doctest: +NORMALIZE_WHITESPACE
    ['three', '__builtin__.IOtherSchema.three']